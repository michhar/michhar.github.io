<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>How to Convert a PyTorch Model to ONNX Format - Data Science <3 Machine Learning</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/obsidian.min.css">
        <link href="../extra_css/extra.css" rel="stylesheet">
        <link href="../extra_css/syntax.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-86308542-1', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">Data Science <3 Machine Learning</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Posts <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../2023-07-poetry-with-conda/" class="dropdown-item">How to Use Poetry with Conda for Package Management on a Specific Python Version</a>
</li>
                                    
<li>
    <a href="../survive-thrive-ds-career/" class="dropdown-item">Survive and Thrive in Your Data Science Career Meetup Summary</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Archive <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2019</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../learning-from-learning-yolov3/" class="dropdown-item">Lessons from YOLO v3 Implementations in PyTorch</a>
</li>
            
<li>
    <a href="../bilstm-crf-this-is-mind-bending/" class="dropdown-item">Named Entity Recognition using a Bi-LSTM with the Conditional Random Field Algorithm</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2018</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../how-i-built-pytorch-gpu/" class="dropdown-item">Building PyTorch with LibTorch From Source with CUDA Support</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">How to Convert a PyTorch Model to ONNX Format</a>
</li>
            
<li>
    <a href="../convolutional-in-layers-and-sequences/" class="dropdown-item">Convolutional Neural Networks in Four Deep Learning Frameworks by Example</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2017</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../cntk-has-feelings-too/" class="dropdown-item">The Cognitive Toolkit (CNTK) Understands How You Feel</a>
</li>
            
<li>
    <a href="../masks_to_polygons_and_back/" class="dropdown-item">Shapely Shapes and OpenCV Visions</a>
</li>
            
<li>
    <a href="../my-new-static-site-generator-hobby/" class="dropdown-item">Overlaying a Website ontop of a GitHub Repository</a>
</li>
            
<li>
    <a href="../two-cents-on-python-package-structure/" class="dropdown-item">Wading In a Tide Pool of Choices, How to Write a Package in Python?</a>
</li>
            
<li>
    <a href="../ocrbot-gets-attached/" class="dropdown-item">OCRBot Gets Attached</a>
</li>
            
<li>
    <a href="../jupyter-and-beaker-make-a-case/" class="dropdown-item">The Notebook Superhero -- Is It Always a Contest?</a>
</li>
            
<li>
    <a href="../javascript-and-python-have-a-party/" class="dropdown-item">Javascript and Python Meet through Magic and IPython</a>
</li>
            
<li>
    <a href="../confusion-matrix-code-revealed/" class="dropdown-item">A Simple, Presentable Confusion Matrix with K-means Data</a>
</li>
            
<li>
    <a href="../a-python-flask-webapp-gets-smart/" class="dropdown-item">Creating a Smart Python Flask Web App using Azure Machine Learning</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2016</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ocrbot-makes-a-connection/" class="dropdown-item">OCRBot Makes a Connection to the Cloud</a>
</li>
            
<li>
    <a href="../how-to-bot-on-mac/" class="dropdown-item">Building an OCR Chat Bot with the Microsoft Bot Framework on my Mac</a>
</li>
            
<li>
    <a href="../teaching-notes-post/" class="dropdown-item">Tips I have Learned by Being a Trainer for a Year</a>
</li>
            
<li>
    <a href="../notebooks1-post/" class="dropdown-item">Python for Data Science Goes Into the Wild</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../how-i-built-pytorch-gpu/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../convolutional-in-layers-and-sequences/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/michhar/michhar.github.io/edit/master/docs/convert-pytorch-onnx.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#the-general-steps" class="nav-link">The General Steps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#prerequisites" class="nav-link">Prerequisites</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#using-a-custom-model-class-and-weights-file" class="nav-link">Using a Custom Model Class and Weights File</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#a-pre-trained-model-from-torchvision" class="nav-link">A Pre-Trained Model from torchvision</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#more-references" class="nav-link">More References</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><img alt="" src="../img/pytorch_loves_onnx.png" /></p>
<p>Posted:  2018-09-27</p>
<p>It might seem tricky or intimidating to convert model formats, but ONNX makes it easier.  However, we must get our PyTorch model into the ONNX format.  This involves both the weights and network architecture defined by a PyToch model class (inheriting from <code>nn.Module</code>).</p>
<p>I don't write out the model classes, however, I wanted to share the steps and code from the point of having the class definition and some weights (either in memory or from a model path file).  One could also do this with the pre-trained models from the torchvision library.</p>
<h2 id="the-general-steps">The General Steps</h2>
<ol>
<li>Define the model class (if using a custom model)</li>
<li>Train the model and/or load the weights, usually a <code>.pth</code> or <code>.pt</code> file by convention, to something usually called the <code>state_dict</code> - note, we are <em>only</em> loading the weights from a file.  A pre-trained model such as is found in <code>torchvision.models</code> may also be used with the provided weights (using <code>pretrained=True</code> - see below).</li>
<li>Create a properly shaped input vector (can be some sample data - the important part is the shape)</li>
<li>(Optional) Give the input and output layers names (to later reference back)</li>
<li>Export to ONNX format with the PyTorch ONNX exporter</li>
</ol>
<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>PyTorch and torchvision installed</li>
<li>A PyTorch model class and model weights</li>
</ol>
<h2 id="using-a-custom-model-class-and-weights-file">Using a Custom Model Class and Weights File</h2>
<p>The Python looks something like:
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.onnx</span>

<span class="c1"># A model class instance (class not shown)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MyModelClass</span><span class="p">()</span>

<span class="c1"># Load the weights from a file (.pth usually)</span>
<span class="n">state_dict</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_path</span><span class="p">)</span>

<span class="c1"># Load the weights now into a model net architecture defined by our class</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>

<span class="c1"># Create the right input shape (e.g. for an image)</span>
<span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">sample_batch_size</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

<span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dummy_input</span><span class="p">,</span> <span class="s2">&quot;onnx_model_name.onnx&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>The state dictionary, or <code>state_dict</code>, is a Python dict containing parameter values and persistent buffers.  (<a href="https://pytorch.org/docs/stable/nn.html#torch.nn.Module.load_state_dict">Docs</a>)</p>
<blockquote>
<p>Note:  The preferred way of saving the weights is with <code>torch.save(the_model.state_dict(), &lt;name_here.pth&gt;)</code>. (<a href="https://pytorch.org/docs/stable/notes/serialization.html#recommended-approach-for-saving-a-model">Docs</a>)</p>
</blockquote>
<h2 id="a-pre-trained-model-from-torchvision">A Pre-Trained Model from torchvision</h2>
<p>If using the <code>torchvision.models</code> pretrained vision models all you need to do is, e.g., for AlexNet:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision.models</span> <span class="k">as</span> <span class="nn">models</span>

<span class="c1"># Use an existing model from Torchvision, note it </span>
<span class="c1"># will download this if not already on your computer (might take time)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">alexnet</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create some sample input in the shape this model expects</span>
<span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">)</span>

<span class="c1"># It&#39;s optional to label the input and output layers</span>
<span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;actual_input_1&quot;</span> <span class="p">]</span> <span class="o">+</span> <span class="p">[</span> <span class="s2">&quot;learned_</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="p">]</span>
<span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;output1&quot;</span> <span class="p">]</span>

<span class="c1"># Use the exporter from torch to convert to onnx </span>
<span class="c1"># model (that has the weights and net arch)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dummy_input</span><span class="p">,</span> <span class="s2">&quot;alexnet.onnx&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_names</span><span class="o">=</span><span class="n">input_names</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="n">output_names</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>Note, the pretrained model weights that comes with <code>torchvision.models</code> went into a home folder <code>~/.torch/models</code> in case you go looking for it later.</p>
</blockquote>
<h2 id="summary">Summary</h2>
<p>Here, I showed how to take a pre-trained PyTorch model (a weights object and network class object) and convert it to ONNX format (that contains the weights and net structure).</p>
<p>As of now, we can not import an ONNX model for use in PyTorch.  There are other projects that are working on this as well as is shown in <a href="https://github.com/ysh329/deep-learning-model-convertor" target="_blank">this list</a>.</p>
<h2 id="more-references">More References</h2>
<ol>
<li><a href="https://pytorch.org/docs/stable/onnx.html#module-torch.onnx" target="_blank">Example: End-to-end AlexNet from PyTorch to Caffe2</a></li>
<li><a href="https://github.com/onnx/onnx" target="_blank">ONNX GitHub</a></li>
<li><a href="https://pytorch.org" target="_blank">PyTorch.org</a></li>
<li><a href="https://github.com/michhar/pytorch-yolo-v3-custom/blob/master/convert2onnx.py" target="_blank">For a more complicated example, see this conversion</a></li>
</ol>
<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function () {
        this.page.url = 'https://michhar.github.io/convolutional-in-layers-and-sequences/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'happycat1'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = 'https://michhar.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
