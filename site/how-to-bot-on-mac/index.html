<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Building an OCR Chat Bot with the Microsoft Bot Framework on my Mac - Data Science <3 Machine Learning Blog</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/obsidian.min.css">
        <link href="../extra_css/extra.css" rel="stylesheet">
        <link href="../extra_css/syntax.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-86308542-1', 'auto');
            ga('send', 'pageview');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="..">Data Science <3 Machine Learning Blog</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Posts <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../survive-thrive-ds-career/" class="dropdown-item">Survive and Thrive in Your Data Science Career Meetup Summary</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Archive <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2019</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../learning-from-learning-yolov3/" class="dropdown-item">Lessons from YOLO v3 Implementations in PyTorch</a>
</li>
            
<li>
    <a href="../bilstm-crf-this-is-mind-bending/" class="dropdown-item">Named Entity Recognition using a Bi-LSTM with the Conditional Random Field Algorithm</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2018</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../how-i-built-pytorch-gpu/" class="dropdown-item">Building PyTorch with LibTorch From Source with CUDA Support</a>
</li>
            
<li>
    <a href="../convert-pytorch-onnx/" class="dropdown-item">How to Convert a PyTorch Model to ONNX Format</a>
</li>
            
<li>
    <a href="../convolutional-in-layers-and-sequences/" class="dropdown-item">Convolutional Neural Networks in Four Deep Learning Frameworks by Example</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2017</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../cntk-has-feelings-too/" class="dropdown-item">The Cognitive Toolkit (CNTK) Understands How You Feel</a>
</li>
            
<li>
    <a href="../masks_to_polygons_and_back/" class="dropdown-item">Shapely Shapes and OpenCV Visions</a>
</li>
            
<li>
    <a href="../my-new-static-site-generator-hobby/" class="dropdown-item">Overlaying a Website ontop of a GitHub Repository</a>
</li>
            
<li>
    <a href="../two-cents-on-python-package-structure/" class="dropdown-item">Wading In a Tide Pool of Choices, How to Write a Package in Python?</a>
</li>
            
<li>
    <a href="../ocrbot-gets-attached/" class="dropdown-item">OCRBot Gets Attached</a>
</li>
            
<li>
    <a href="../jupyter-and-beaker-make-a-case/" class="dropdown-item">The Notebook Superhero -- Is It Always a Contest?</a>
</li>
            
<li>
    <a href="../javascript-and-python-have-a-party/" class="dropdown-item">Javascript and Python Meet through Magic and IPython</a>
</li>
            
<li>
    <a href="../confusion-matrix-code-revealed/" class="dropdown-item">A Simple, Presentable Confusion Matrix with K-means Data</a>
</li>
            
<li>
    <a href="../a-python-flask-webapp-gets-smart/" class="dropdown-item">Creating a Smart Python Flask Web App using Azure Machine Learning</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">2016</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ocrbot-makes-a-connection/" class="dropdown-item">OCRBot Makes a Connection to the Cloud</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Building an OCR Chat Bot with the Microsoft Bot Framework on my Mac</a>
</li>
            
<li>
    <a href="../teaching-notes-post/" class="dropdown-item">Tips I have Learned by Being a Trainer for a Year</a>
</li>
            
<li>
    <a href="../notebooks1-post/" class="dropdown-item">Python for Data Science Goes Into the Wild</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ocrbot-makes-a-connection/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../teaching-notes-post/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/michhar/michhar.github.io/edit/master/docs/how-to-bot-on-mac.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p><strong>Posted:</strong>  2016-11-07</p>
<p><strong>Command Line Emulator for the Bot Framework - interacting with ocrbot on Shakespeare</strong>
<br><br></p>
<p>UPDATE:  The Command Line Emulator has been replaced with a full-fledged emulator which is cross-platform (info and install <a href="https://github.com/Microsoft/BotFramework-Emulator">here</a>).</p>
<p><strong>tl;dr</strong>: I built a simple OCR bot using the Bot Framework (BF) from Microsoft and the Cognitive Services Computer Vision API.  I chose the Node.js Bot Builder SDK from BF.  I tested with the BF's unix-compatible emulator (black box above).  It was nice and straightforward the whole way through.  All of the instructions are <a href="https://github.com/michhar/bot-education-ocrbot/blob/master/LabStart.md">here</a>, but feel free to keep reading.</p>
<p>There's really almost too much to say about chat bots:  definitions, bot builders, history (<a href="http://venturebeat.com/2016/08/15/a-short-history-of-chatbots-and-artificial-intelligence/">more</a>), warnings and cautionary tales (<a href="http://venturebeat.com/2016/08/15/a-short-history-of-chatbots-and-artificial-intelligence/">more</a>), guidelines, delightful stories, sad stories, etc.  For our purposes, other than a few considerations, I'll sum it up with: they've been around for decades and will be for many more.</p>
<p>However, let's cover some vocabulary to start.</p>
<p>A blog post <a href="http://willschenk.com/bot-design-patterns/?imm_mid=0e50a2&amp;cmp=em-data-na-na-newsltr_20160622">here</a> details the different types of chat bots, progressing from simple to ones that can hold down a conversation.  These are the bot types discussed and an example to illustrate:</p>
<ol>
<li>Notifier - sends a one-way message e.g. <em>ping me with today's weather forecast at the start of the day ("push" bot i.e. bot initiates)</em></li>
<li>Reactor - replies when I send a message, but does not remember anything <em>e.g. send me the weather forecast when I ask for it ("pull bot" i.e. I initiate), but don't remember me or what I ask for</em></li>
<li>Responder - replies and remembers me and my message history e.g. <em>send me today's weather forecast, use my user name on this channel, and remember what cities I choose</em></li>
<li>Conversationalist - replies, remembers me and my message history, knows what service I'm on, if there are others there, and when I come and go e.g. <em>send me today's weather forecast, use my user name on this channel, remember what cities I choose, format it nicely for this channel, and if the conversation is old, archive it and send as email</em></li>
</ol>
<p>Bot builders lower the activation barrier for developing bots and the MS Bot Framework (BF) Bot Builder SDKs give us a wealth of methods for building dialog and user prompts, making the creation of effective waterfalls really easy.  Along with the SDKs, the BF provides free emulator tools, a Windows-compatible desktop app and a Mac OS X / Linux-compatible console app (more information on emulators <a href="https://docs.botframework.com/en-us/tools/bot-framework-emulator/#navtitle">here</a>).</p>
<p>I know you've been waiting to dive into the code, so let's begin...</p>
<p>There are two choices on bot builder functions for testing locally.  We can use the <code>ConsoleConnector</code> which simply and directly allows us to run our Node.js code on the command line.  Using the bot builder SDK our code is pretty concise (see more examples on the Core Concepts page for the BF <a href="https://docs.botframework.com/en-us/node/builder/guides/core-concepts/#navtitle">here</a>):</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botbuilder&#39;</span><span class="p">);</span>

<span class="c1">// Create a bot and connect it to the console</span>
<span class="kd">var</span> <span class="nx">connector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">ConsoleConnector</span><span class="p">().</span><span class="nx">listen</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">UniversalBot</span><span class="p">(</span><span class="nx">connector</span><span class="p">);</span>
</code></pre></div>
<br></p>
<p>Interacting with ocrbot could look like:</p>
<p><img alt="console connector" src="/img/ocrbot_console_connect.png" /><br></p>
<p>It's simple, but we don't get to see the actual JSON that gets passed to the bot and the JSON passed back.  If we want to be able to see the message and also write code that can be used for production later, the Bot Framework Emulator is the way to go.   Note, this is the beginning of my server.js Node.js file - see my <a href="https://github.com/michhar/bot-education-ocrbot">ocrbot github repo</a> for the complete project and code and the included <a href="https://github.com/michhar/bot-education-ocrbot/blob/master/LabStart.md">lab file</a> for more instructions on doing this at home.  We replace  <code>ConsoleConnector</code> with <code>ChatConnector</code>, for a full deployment-compatible setup, as follows:</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">restify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;restify&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;botbuilder&#39;</span><span class="p">);</span>

<span class="c1">// Create bot</span>
<span class="kd">var</span> <span class="nx">connector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">ChatConnector</span><span class="p">(</span><span class="nx">botConnectorOptions</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">UniversalBot</span><span class="p">(</span><span class="nx">connector</span><span class="p">);</span>

<span class="c1">// Setup Restify Server</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">restify</span><span class="p">.</span><span class="nx">createServer</span><span class="p">();</span>

<span class="c1">// Handle Bot Framework messages</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/messages&#39;</span><span class="p">,</span> <span class="nx">connector</span><span class="p">.</span><span class="nx">listen</span><span class="p">());</span>

<span class="c1">// Serve a static web page - for testing deployment</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sr">/.*/</span><span class="p">,</span> <span class="nx">restify</span><span class="p">.</span><span class="nx">serveStatic</span><span class="p">({</span>
    <span class="s1">&#39;directory&#39;</span><span class="o">:</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;default&#39;</span><span class="o">:</span> <span class="s1">&#39;index.html&#39;</span>
<span class="p">}));</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">port</span> <span class="o">||</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3978</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;%s listening to %s&#39;</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span> 
<span class="p">});</span>
</code></pre></div>
<br></p>
<p>One of the major reasons I used github to host this project is that (and outlined in a later blog, TBD) it afforded me the ability to do a continuous deployment directly from the repo.  Any change I push up, immediately reflects in my bot on whichever channel I'm on - it was actually pretty astonishing to see a quick typo fix show up so immediately when chatting to my bot at the same time as pushing up the change.  But I'll save this for the deployment article to come.</p>
<p>I've always been a fan of command terminals, so even on a Windows machine I'd probably choose to download and use the BF Command Terminal Emulator (download instructions are <a href="https://docs.botframework.com/en-us/tools/bot-framework-emulator/#mac-and-linux-support-using-command-line-emulator">here</a>).  Honestly, I enjoy the simplicity and control a command prompt affords.  And now I can develop bots in the <em>exact</em> same way agnostic of OS.</p>
<p>So, I decided to create a bot I could give image links to and if there was text in the picture it would reply with that text.  Pretty simple and straightforward since I knew about the free subscriptions to Microsoft Cognitive Services and in particular the Vision APIs.  I went to the Cognitive Services main page and clicked on My Account and signed up (or I could have signed up <a href="https://www.microsoft.com/cognitive-services/en-US/sign-up?ReturnUrl=/cognitive-services/en-us/subscriptions">this way</a> with MS, github, or LinkedIn accounts).  After that I had a secret key for the service.  Now to splice that into my bot.</p>
<p>So, I borrowed much of my code from Samuele Resca's <a href="https://samueleresca.net/2016/10/build-universal-bot-using-nodejs/">blog post</a> (excellent blog, btw).  I placed these helper methods in with the server.js code above:</p>
<p><div class="highlight"><pre><span></span><code><span class="c1">//=========================================================</span>
<span class="c1">// URL Helpers</span>
<span class="c1">//=========================================================</span>


<span class="kd">var</span> <span class="nx">extractUrl</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_extractUrl</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s2">&quot;message&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span>
        <span class="o">&amp;&amp;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">contentUrl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">!==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_findUrl</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="p">};</span>


<span class="kd">function</span> <span class="nx">_findUrl</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="p">(</span><span class="nx">text</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">matchArray</span><span class="p">;</span>

    <span class="c1">// Regular expression to find FTP, HTTP(S) and email URLs.</span>
    <span class="kd">var</span> <span class="nx">regexToken</span> <span class="o">=</span> <span class="sr">/(((http|https?):\/\/)[\-\w@:%_\+.~#?,&amp;\/\/=]+)/g</span><span class="p">;</span>

    <span class="c1">// Iterate through any URLs in the text.</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">matchArray</span> <span class="o">=</span> <span class="nx">regexToken</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">source</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">matchArray</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<br></p>
<p>Then I set up a config file as shown in the <a href="https://github.com/michhar/bot-education-ocrbot/blob/master/configuration.js">repository</a> containing my Computer Vision API key (as well as placeholders for the future app id and app password I get after the deployment step - in a followup article TBD).  So, don't worry about the app id and app password for now.</p>
<p>If you are doing this at home, replace the <code>process.env.VISION_API_KEY</code> with a string holding your key (this is a separate file I called <code>configuration.js</code>), see instructions in this <a href="https://github.com/michhar/bot-education-ocrbot/blob/master/LabStart.md">lab file</a>.</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// Ignore this part for now...</span>
    <span class="nx">CHAT_CONNECTOR</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">APP_ID</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MICROSOFT_APP_ID</span><span class="p">,</span> <span class="c1">//You can obtain an APP ID and PASSWORD here: https://dev.botframework.com/bots/new</span>
        <span class="nx">APP_PASSWORD</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MICROSOFT_APP_PASSWORD</span>
    <span class="p">},</span>

    <span class="c1">//  Replace the API_KEY below with yours from the free trial</span>
    <span class="nx">COMPUTER_VISION_SERVICE</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">API_URL</span><span class="o">:</span> <span class="s2">&quot;https://api.projectoxford.ai/vision/v1.0/&quot;</span><span class="p">,</span>
        <span class="nx">API_KEY</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VISION_API_KEY</span>  <span class="c1">//You can obtain an COGNITIVE SERVICE API KEY: https://www.microsoft.com/cognitive-services/en-us/pricing</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">CONFIGURATIONS</span> <span class="o">=</span> <span class="nx">_config</span><span class="p">;</span>
</code></pre></div>
<br></p>
<p>Then back in my <code>server.js</code> file with the main code I set up my vision OCR functions to read the image text (basically call out the the Computer Vision service with an image url) and then process the text:</p>
<p><div class="highlight"><pre><span></span><code><span class="c1">//=========================================================</span>
<span class="c1">// Vision Service</span>
<span class="c1">//=========================================================</span>

<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">readImageText</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_readImageText</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CONFIGURATIONS</span><span class="p">.</span><span class="nx">COMPUTER_VISION_SERVICE</span><span class="p">.</span><span class="nx">API_URL</span> <span class="o">+</span> <span class="s2">&quot;ocr/&quot;</span><span class="p">,</span>
        <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;ocp-apim-subscription-key&#39;</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CONFIGURATIONS</span><span class="p">.</span><span class="nx">COMPUTER_VISION_SERVICE</span><span class="p">.</span><span class="nx">API_KEY</span><span class="p">,</span>
            <span class="s1">&#39;content-type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">},</span>
        <span class="nx">body</span><span class="o">:</span> <span class="p">{</span><span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">language</span><span class="o">:</span> <span class="s2">&quot;en&quot;</span><span class="p">},</span>
        <span class="nx">json</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">};</span>

    <span class="nx">request</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>

<span class="p">};</span>

<span class="kd">var</span> <span class="nx">extractText</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">_extractText</span><span class="p">(</span><span class="nx">bodyMessage</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">bodyMessage</span><span class="p">.</span><span class="nx">regions</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">regs</span> <span class="o">=</span> <span class="nx">bodyMessage</span><span class="p">.</span><span class="nx">regions</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span>
        <span class="nx">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="nx">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lines</span><span class="p">;</span>

        <span class="c1">// For all lines in image ocr result</span>
        <span class="c1">//   grab the text in the words array</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">words</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">words</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">words</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">text</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">words</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">text</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s2">&quot;Sorry, I can&#39;t find text in it :( !&quot;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<br></p>
<p>Finally, we tie it all together in a user dialog:</p>
<p><div class="highlight"><pre><span></span><code><span class="c1">//=========================================================</span>
<span class="c1">// Bots Dialogs</span>
<span class="c1">//=========================================================</span>

<span class="nx">bot</span><span class="p">.</span><span class="nx">dialog</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Use our url helper method</span>
    <span class="kd">var</span> <span class="nx">extractedUrl</span> <span class="o">=</span> <span class="nx">extractUrl</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>

    <span class="c1">// Nothing returned?  Ask for an image url again...</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">extractedUrl</span> <span class="o">===</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">session</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Hello.  I&#39;m an OCRBot.  Please give me an image link and I&#39;ll look for words.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Get a valid url?  Send it off to the Vision API for OCR...</span>
    <span class="nx">readImageText</span><span class="p">(</span><span class="nx">extractedUrl</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">session</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">extractText</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
    <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>
<br></p>
<p>We could have added a waterfall here to say confirm they want to process this image or perhaps added a built-in prompt that allows uploading an image attachment.  Perhaps in future releases.</p>
<p>Now we test.</p>
<p>On Windows one would double click on the BFEmulator.exe directly and on Mac we use the Mono framework software to run BFEmulator.exe from the command line.  Pretty easy, peasy.</p>
<p>Let's take this image:</p>
<p><img alt="Ronald Fisher quote" src="http://www.azquotes.com/picture-quotes/quote-to-consult-the-statistician-after-an-experiment-is-finished-is-often-merely-to-ask-him-ronald-fisher-9-70-13.jpg" /><br></p>
<p>The emulator experience will look a little something like:</p>
<p><img alt="ocrbot local on stats" src="/img/ocrbot_on_stats.png" /><br>
<strong>Command Line Emulator for the Bot Framework - interacting with ocrbot locally on stats</strong></p>
<p>In conclusion, to get started now, check out the github repo and start playing with the code and emulator.  For more instructions check out <a href="https://github.com/michhar/bot-education-ocrbot/blob/master/LabStart.md">this lab</a>.  Chat later!</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/0.0.1/prism.min.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
